@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix fvc: <http://w3id.org/FAIRVASC#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix sno: <http://purl.bioontology.org/ontology/SNOMEDCT#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix ordo:<http://www.orpha.net/ORDO/> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .	
@prefix dpv: <https://w3id.org/dpv/dpv-owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .

<#patient>

	rr:logicalTable [ rr:sqlQuery """SELECT 
		RECORD_ID, 
		YEAR_OF_BIRTH,   
		DRUG_SELECTED_CHOICES,
		GENDER,
			CASE 
			WHEN GENDER = 1 THEN 'C20197' 
			WHEN GENDER = 2 THEN 'C16576' 
			WHEN GENDER = 3 THEN 'C41438' 
		END AS GENDER_
	FROM RKD""" ];
	
	rr:subjectMap [
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/patient/{RECORD_ID}" ;
		rr:class fvc:Patient;
	] ;
		
	rr:predicateObjectMap [
		rr:predicate fvc:patientID ;
		rr:objectMap [			
			rr:column "RECORD_ID" ;
			rr:datatype xsd:string;
		] ;
	] ;
	
	rr:predicateObjectMap [
		rr:predicate fvc:yearOfBirth ;
		rr:objectMap [			
			rr:column "YEAR_OF_BIRTH" ;
			rr:datatype xsd:gYear;
		] ;
	] ;

	rr:predicateObjectMap [
		rr:predicate fvc:gender ;
		rr:objectMap [ 
			rr:template "http://identifiers.org/ncit:{GENDER_}" ;
			];
	] ;
	
	
    rr:predicateObjectMap [
        rr:predicate rdf:type;
        rr:objectMap [ rr:constant dpv:Patient ];
    ];              


	rr:predicateObjectMap [
		rr:predicate fvc:hasPatientOverview;
		rr:objectMap [
		rr:parentTriplesMap <#patient_overview> ;
		rr:joinCondition [
			rr:child "RECORD_ID" ;
			rr:parent "RECORD_ID" ;
		] ;
		] ;
	];

.

<#patient_overview>

	rr:logicalTable [ rr:sqlQuery """SELECT 
		RECORD_ID,
		DRUG_SELECTED_CHOICES,
		RELAPSE_DATE ||'T00:00:00' AS RELAPSE_DATE,
		IV_THERAPY,
	FROM RKD""" ];
	
	rr:subjectMap [
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/patient/patientoverview/{RECORD_ID}" ;
		rr:class fvc:PatientOverview;
	] ;


	rr:predicateObjectMap [
		rr:predicate fvc:hasConMed;
		rr:objectMap [
		rr:parentTriplesMap <#drug_selected_choices> ;
		rr:joinCondition [
			rr:child "RECORD_ID" ;
			rr:parent "RECORD_ID" ;
		] ;
		] ;
	];

	rr:predicateObjectMap [
		rr:predicate fvc:hasIVTherapy;
		rr:objectMap [
		rr:parentTriplesMap <#iv_therapy> ;
		rr:joinCondition [
			rr:child "RECORD_ID" ;
			rr:parent "RECORD_ID" ;
		] ;
		] ;
	];

	rr:predicateObjectMap [
		rr:predicate fvc:relapseDate;
		rr:objectMap [ 
			rr:column "RELAPSE_DATE";
			rr:datatype xsd:datetime;
		];
    ];	


.

<#drug_selected_choices>
	rr:logicalTable [ rr:sqlQuery """
	SELECT 			
		RECORD_ID,
		DRUG_SELECTED_CHOICES,
		CASE 
			WHEN DRUG_SELECTED_CHOICES = 1 THEN 'C769' 
			WHEN DRUG_SELECTED_CHOICES = 2 THEN 'C405' 
			WHEN DRUG_SELECTED_CHOICES = 3 THEN 'C290' 
			WHEN DRUG_SELECTED_CHOICES = 4 THEN 'C1468' 
			WHEN DRUG_SELECTED_CHOICES = 5 THEN 'C642'  
			WHEN DRUG_SELECTED_CHOICES = 6 THEN 'Other' 
			WHEN DRUG_SELECTED_CHOICES = 7 THEN 'C174788' 
		END AS DRUG_ENCODING
	FROM RKD
		""" ];
	
	rr:subjectMap [
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/overview/ContinuingMedication/{RECORD_ID}{DRUG_ENCODING}" ;
		rr:class fvc:ContinuingMedication;
	] ;
	rr:predicateObjectMap [
		rr:predicate fvc:cmTreatmentType;
		rr:objectMap [ 
			rr:template "http://identifiers.org/ncit:{DRUG_ENCODING}"
		];
	];
.

<#iv_therapy>
	rr:logicalTable [ rr:sqlQuery """
	SELECT 			
		RECORD_ID,
		DATE_OF_IV_THERAPY||'T00:00:00' DATE_OF_IV_THERAPY,
		IV_THERAPY,
		CASE 
			WHEN iv_therapy = 1 THEN 'C769' 
			WHEN iv_therapy = 2 THEN 'C17998' 
			WHEN iv_therapy = 3 THEN 'C405' 
			WHEN iv_therapy = 4 THEN 'C15304' 
			WHEN iv_therapy = 5 THEN 'C1702'  
			WHEN iv_therapy = 6 THEN 'Other' 
			WHEN iv_therapy = 7 THEN 'C290' 
			WHEN iv_therapy = 8 THEN 'Vaccine' 
			WHEN iv_therapy = 9 THEN 'C1128' 
		END AS DRUG_ENCODING
	FROM RKD
		""" ];
	
	rr:subjectMap [
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/overview/Ivtherapy/{RECORD_ID}{DRUG_ENCODING}" ;
		rr:class fvc:Ivtherapy;
	] ;

	
	rr:predicateObjectMap [
		rr:predicate fvc:ivTreatmentType;
		rr:objectMap [ 
			rr:template "http://identifiers.org/ncit:{DRUG_ENCODING}"
		];
    ];	
			
.

<#hasConMed>
	rr:logicalTable [ rr:sqlQuery """
	SELECT 			
		RECORD_ID,
		STOP_DATE||'T00:00:00' AS STOP_DATE,
		START_DATE||'T00:00:00' AS START_DATE,
		DRUG_SELECTED_CHOICES,
		CASE 
			WHEN DRUG_SELECTED_CHOICES = 1 THEN 'C769' 
			WHEN DRUG_SELECTED_CHOICES = 2 THEN 'C405' 
			WHEN DRUG_SELECTED_CHOICES = 3 THEN 'C290' 
			WHEN DRUG_SELECTED_CHOICES = 4 THEN 'C1468' 
			WHEN DRUG_SELECTED_CHOICES = 5 THEN 'C642'  
			WHEN DRUG_SELECTED_CHOICES = 6 THEN 'Other' 
			WHEN DRUG_SELECTED_CHOICES = 7 THEN 'C174788' 
		END AS DRUG_ENCODING,
	FROM RKD
		""" ];
	
	rr:subjectMap [
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/patient/patientoverview/ContinuingMedication/hasConMed/{RECORD_ID}{DRUG_ENCODING}{START_DATE}{STOP_DATE}";
		rr:class fvc:hasConMed;
	] ;
	


	rr:predicateObjectMap [
		rr:predicate rdf:singletonPropertyOf ;
		rr:objectMap [ 
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/patient/patientoverview/ContinuingMedication/hasConMed/{RECORD_ID}{DRUG_ENCODING}" ;
			];
	] ;


 	rr:predicateObjectMap [
		rr:predicate fvc:cmStartDate;
		rr:objectMap [ 
			rr:column "START_DATE" ;
			rr:datatype xsd:datetime;
		];
    ];	

        rr:predicateObjectMap [
		rr:predicate fvc:cmStopDate;
		rr:objectMap [ 
			rr:column "STOP_DATE";
			rr:datatype xsd:datetime;
		];
    ];	
.

<#hasIVTherapy>
	rr:logicalTable [ rr:sqlQuery """
	SELECT 			
		RECORD_ID,
		DATE_OF_IV_THERAPY||'T00:00:00' DATE_OF_IV_THERAPY,
		IV_THERAPY,
		CASE 
			WHEN iv_therapy = 1 THEN 'C769' 
			WHEN iv_therapy = 2 THEN 'C17998' 
			WHEN iv_therapy = 3 THEN 'C405' 
			WHEN iv_therapy = 4 THEN 'C15304' 
			WHEN iv_therapy = 5 THEN 'C1702'  
			WHEN iv_therapy = 6 THEN 'Other' 
			WHEN iv_therapy = 7 THEN 'C290' 
			WHEN iv_therapy = 8 THEN 'Vaccine' 
			WHEN iv_therapy = 9 THEN 'C1128' 
		END AS DRUG_ENCODING,
	FROM RKD
		""" ];
	
	rr:subjectMap [
		rr:template "http://w3id.org/FAIRVASC/resource/rkd/patient/patientoverview/Ivtherapy/hasIVTherapy/{RECORD_ID}{DRUG_ENCODING}{DATE_OF_IV_THERAPY}";
		rr:class fvc:hasIVTherapy;
	] ;
	


	rr:predicateObjectMap [
		rr:predicate rdf:singletonPropertyOf ;
		rr:objectMap [ 
			rr:template "http://w3id.org/FAIRVASC/resource/rkd/patient/patientoverview/Ivtherapy/hasIVTherapy/{RECORD_ID}{DRUG_ENCODING}" ;
			];
	] ;


 	rr:predicateObjectMap [
		rr:predicate fvc:IVTherapyDate;
		rr:objectMap [ 
			rr:column "DATE_OF_IV_THERAPY" ;
			rr:datatype xsd:datetime;
		];
    ];	

       .


